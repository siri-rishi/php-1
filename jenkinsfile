pipeline{
    agent any
    environment{
        IMAGE_NAME ='sirishadevops/java-mvn-privaterepos:php$BUILD_NUMBER'
        SERVER_IP ='ec2-user@15.207.84.42'
    }
    stages{
        stage('Build docker image'){
            agent any
             steps{
                 script{
        sshagent(['Test_Server_Key']) {
        withcridentials([usernamepassword(cridentialsId: 'docker-hub', passwordvarible: 'PASSWORD', usernamevariable: 'username')]){
    echo "Building the docker image"
    sh "scp -o strictHostkeychecking=no -r docker-files ${SERVER_IP}:/home/ec2-user"
    sh "ssh -o strictHostkeychecking=no ${SERVER_IP} 'bash ~/docker-files/docker-script.sh'"
    sh "ssh ${SERVER_IP} sudo docker build -t ${IMAGE_NAME} /home/ec2-user/docker-files/"          
    sh "ssh ${SERVER_IP} sudo docker login -u $USERNAME -p $PASSWORD"
    sh "ssh ${SERVER_IP} sudo docker push ${IMAGE_NAME}"
                }       
            }     
        }
          }
}
    }
}